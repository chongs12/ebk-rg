
services:
  auth:
    build:
      context: .
      dockerfile: ./cmd/auth/Dockerfile
    container_name: ekb-auth
    environment:
      SERVER_PORT: "8081"
      EKB_AUTH_PORT: "8081"
      SERVER_MODE: "production"
      DB_HOST: host.docker.internal
      DB_PORT: "3308"
      DB_USERNAME: ${DB_USERNAME}
      DB_PASSWORD: ${DB_PASSWORD}
      DB_NAME: ${DB_NAME}
      REDIS_HOST: host.docker.internal
      REDIS_PORT: "6383"
      REDIS_DB: "0"
      JWT_SECRET: "local-secret"
      JWT_ISSUER: "ekb-local"
      JAEGER_ENDPOINT: "jaeger:4317"
    ports:
      - "8081:8081"
    networks:
      - ekb-net

  document:
    build:
      context: .
      dockerfile: ./cmd/document/Dockerfile
    container_name: ekb-document
    environment:
      SERVER_PORT: "8082"
      EKB_DOCUMENT_PORT: "8082"
      SERVER_MODE: "production"
      DB_HOST: host.docker.internal
      DB_PORT: "3308"
      DB_USERNAME: ${DB_USERNAME}
      DB_PASSWORD: ${DB_PASSWORD}
      DB_NAME: ${DB_NAME}
      REDIS_HOST: host.docker.internal
      REDIS_PORT: "6383"
      REDIS_DB: "0"
      UPLOAD_PATH: "/app/uploads"
      GW_ENTRY_BASE_URL: "http://gateway:8080"
      JWT_SECRET: "local-secret"
      JWT_ISSUER: "ekb-local"
      JAEGER_ENDPOINT: "jaeger:4317"
    volumes:
      - uploads:/app/uploads
    ports:
      - "8082:8082"
    networks:
      - ekb-net

  vector:
    build:
      context: .
      dockerfile: ./cmd/vector/Dockerfile
    container_name: ekb-vector
    environment:
      SERVER_PORT: "8083"
      EKB_VECTOR_PORT: "8083"
      SERVER_MODE: "production"
      DB_HOST: host.docker.internal
      DB_PORT: "3308"
      DB_USERNAME: ${DB_USERNAME}
      DB_PASSWORD: ${DB_PASSWORD}
      DB_NAME: ${DB_NAME}
      REDIS_HOST: host.docker.internal
      REDIS_PORT: "6383"
      REDIS_DB: "0"
      MILVUS_ADDR: "host.docker.internal:19530"
      MILVUS_COLLECTION: "eino_collection"
      MILVUS_VECTOR_FIELD: "vector"
      MILVUS_VECTOR_DIM: "4096"
      MILVUS_VECTOR_TYPE: "float"
      ARK_API_KEY: ${ARK_API_KEY}
      ARK_MODEL: "doubao-embedding-large-text-240915"
      ARK_BASE_URL: "https://ark.cn-beijing.volces.com/api/v3"
      ARK_REGION: "cn-beijing"
      JWT_SECRET: "local-secret"
      JWT_ISSUER: "ekb-local"
      JAEGER_ENDPOINT: "jaeger:4317"
      EKB_VECTOR_GRPC_PORT: "50053"
    ports:
      - "8083:8083"
      - "50053:50053"
    networks:
      - ekb-net

  query:
    build:
      context: .
      dockerfile: ./cmd/query/Dockerfile
    container_name: ekb-query
    environment:
      SERVER_PORT: "8084"
      EKB_QUERY_PORT: "8084"
      SERVER_MODE: "production"
      DB_HOST: host.docker.internal
      DB_PORT: "3308"
      DB_USERNAME: ${DB_USERNAME}
      DB_PASSWORD: ${DB_PASSWORD}
      DB_NAME: ${DB_NAME}
      REDIS_HOST: host.docker.internal
      REDIS_PORT: "6383"
      REDIS_DB: "0"
      ARK_API_KEY: ${ARK_API_KEY}
     
      ARK_BASE_URL: "https://ark.cn-beijing.volces.com/api/v3"
      ARK_REGION: "cn-beijing"
      RAG_MODEL: "doubao-seed-1-6-251015"
      GW_ENTRY_BASE_URL: "http://gateway:8080"
      JWT_SECRET: "local-secret"
      JWT_ISSUER: "ekb-local"
      JAEGER_ENDPOINT: "jaeger:4317"
      VECTOR_GRPC_ADDR: "vector:50053"
    ports:
      - "8084:8084"
    networks:
      - ekb-net

  gateway:
    build:
      context: .
      dockerfile: ./cmd/gateway/Dockerfile
    container_name: ekb-gateway
    depends_on:
      - auth
      - document
      - vector
      - query
    environment:
      SERVER_PORT: "8080"
      EKB_GATEWAY_PORT: "8080"
      SERVER_MODE: "production"
      GW_AUTH_BASE_URL: "http://auth:8081"
      GW_DOCUMENT_BASE_URL: "http://document:8082"
      GW_VECTOR_BASE_URL: "http://vector:8083"
      GW_QUERY_BASE_URL: "http://query:8084"
      GW_ENTRY_BASE_URL: "http://gateway:8080"
      JWT_SECRET: "local-secret"
      JWT_ISSUER: "ekb-local"
      JAEGER_ENDPOINT: "jaeger:4317"
    ports:
      - "8080:8080"
    networks:
      - ekb-net

  prometheus:
    image: prom/prometheus:v3.7.3
    container_name: ekb-prometheus
    ports:
      - "9090:9090"
    volumes:
      - ./monitoring/prometheus/prometheus.yml:/etc/prometheus/prometheus.yml:ro
    networks:
      - ekb-net

  grafana:
    image: grafana/grafana:12.2.1
    container_name: ekb-grafana
    ports:
      - "3000:3000"
    environment:
      GF_SECURITY_ADMIN_USER: ${GRAFANA_ADMIN_USER:-admin}
      GF_SECURITY_ADMIN_PASSWORD: ${GRAFANA_ADMIN_PASSWORD:-admin}
    volumes:
      - ./monitoring/grafana/provisioning/datasources/datasource.yml:/etc/grafana/provisioning/datasources/datasource.yml:ro
      - ./monitoring/grafana/provisioning/dashboards:/etc/grafana/provisioning/dashboards:ro
    networks:
      - ekb-net

  jaeger:
    image: jaegertracing/all-in-one:1.57
    container_name: ekb-jaeger
    environment:
      - COLLECTOR_OTLP_ENABLED=true
    ports:
      - "16686:16686" # UI
      - "4317:4317"   # OTLP gRPC
      - "4318:4318"   # OTLP HTTP
    networks:
      - ekb-net

networks:
  ekb-net:
    driver: bridge

volumes:
  uploads:
  prom-data:
  grafana-data:
